<div class="dashboard">
  <div class="header">
    <div>
      <h2>Inventory Pulse</h2>
      <p class="muted">Real-time snapshot of stock health across warehouses.</p>
    </div>
    <button mat-stroked-button color="primary" (click)="load(true)">Refresh</button>
  </div>

  @if (loading()) {
  <div class="state">
    <mat-spinner diameter="36"></mat-spinner>
    <span>Loading metrics...</span>
  </div>
  }

  @if (!loading() && error()) {
  <div class="state error" role="alert" aria-live="assertive">
    <mat-icon color="warn">error</mat-icon>
    <span>{{ error() }}</span>
    <button mat-button color="primary" (click)="load(true)">Retry</button>
  </div>
  }

  @if (!loading() && hasData()) {
  <div class="cards">
    <mat-card class="kpi">
      <div class="icon bg-blue"><mat-icon>inventory</mat-icon></div>
      <div>
        <div class="label">Total Products</div>
        <div class="value">{{ data()!.totalProducts }}</div>
        <div class="hint">{{ data()!.activeProducts }} active</div>
      </div>
    </mat-card>

    <mat-card class="kpi">
      <div class="icon bg-purple"><mat-icon>store</mat-icon></div>
      <div>
        <div class="label">Warehouses</div>
        <div class="value">{{ data()!.totalWarehouses }}</div>
        <div class="hint">{{ data()!.activeWarehouses }} operating</div>
      </div>
    </mat-card>

    <mat-card class="kpi warn">
      <div class="icon bg-amber"><mat-icon>warning</mat-icon></div>
      <div>
        <div class="label">Low Stock Items</div>
        <div class="value">{{ data()!.lowStockItems }}</div>
        <div class="hint">Needs attention</div>
      </div>
    </mat-card>

    <mat-card class="kpi danger">
      <div class="icon bg-red"><mat-icon>do_not_disturb_on</mat-icon></div>
      <div>
        <div class="label">Dead Stock</div>
        <div class="value">{{ data()!.deadStockItems }}</div>
        <div class="hint">No movement</div>
      </div>
    </mat-card>

    <mat-card class="kpi wide">
      <div class="icon bg-green"><mat-icon>payments</mat-icon></div>
      <div>
        <div class="label">Total Stock Value</div>
        <div class="value">{{ data()!.totalStockValue | currency:'USD':'symbol':'1.0-0' }}</div>
        <div class="hint">FIFO / Weighted average as per report</div>
      </div>
    </mat-card>
  </div>

  <div class="recent">
    <div class="recent-head">
      <div>
        <h3>Recent Movements</h3>
        <p class="muted">Latest 10 stock transactions across all warehouses.</p>
      </div>
      <button mat-stroked-button color="primary" (click)="loadRecent()">Refresh list</button>
    </div>

    @if (recentLoading()) {
    <div class="recent-loading">
      <app-loading message="Fetching recent movements..." />
    </div>
    }

    @if (!recentLoading() && recentError()) {
    <div class="state error" role="alert" aria-live="assertive">
      <mat-icon color="warn">error</mat-icon>
      <span>{{ recentError() }}</span>
      <button mat-button (click)="loadRecent()">Retry</button>
    </div>
    }

    @if (!recentLoading() && !recentError() && recentMovements().length === 0) {
    <app-empty-state
      icon="timeline"
      title="No movements yet"
      description="Stock transactions will appear here as soon as you receive or issue items.">
    </app-empty-state>
    }

    @if (!recentLoading() && recentMovements().length) {
    <div class="timeline">
      @for (m of recentMovements(); track m.transactionId) {
      <div class="row">
        <div class="left">
          <div class="title">{{ m.productName }} ({{ m.sku }})</div>
          <div class="sub">{{ m.warehouseCode }} â€¢ {{ m.locationCode || '-' }}</div>
        </div>
        <div class="meta">
          <span class="pill" [class.in]="m.quantityDelta > 0" [class.out]="m.quantityDelta < 0">
            {{ m.type }}
          </span>
          <div class="qty">{{ m.quantityDelta }}</div>
          <div class="date">{{ m.createAt | date:'MMM d, HH:mm' }}</div>
        </div>
      </div>
      }
    </div>
    }
  </div>
  }
</div>
